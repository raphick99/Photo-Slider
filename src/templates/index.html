<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Slider</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            overflow: hidden;
        }
        #photo-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000; /* Add black background for letterboxing */
        }
        #photo-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #photo-container img.loaded {
            opacity: 1;
        }
        .error {
            color: #ff4444;
            font-size: 24px;
            font-family: Arial, sans-serif;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
        }
        .no-photos {
            color: #ffffff;
            font-size: 24px;
            font-family: Arial, sans-serif;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
        }
    </style>
    <script>
        window.TENANT_ID = "{{ tenant_id }}";
    </script>
</head>
<body>
    <div id="photo-container"></div>

    <script>
        class PhotoSlider {
            constructor() {
                this.config = null;
                this.container = document.getElementById('photo-container');
                this.displayTime = 10000; // Default display time in ms
                this.retryDelay = 5000; // Delay before retrying when no photos are available
                this.tenantId = window.TENANT_ID;

                // Timer management
                this.timer = null;

                // Photo preloading system
                this.currentPhoto = null;
                this.nextPhoto = null;
                this.isPreloading = false;

                // State
                this.isRunning = false;
            }

            async initialize() {
                try {
                    await this.loadConfiguration();
                    this.setupEventListeners();
                    await this.start();
                } catch (error) {
                    console.error('Error initializing slider:', error);
                    this.showError('Error loading configuration');
                }
            }

            async loadConfiguration() {
                const response = await fetch('/configuration', {
                    headers: { 'X-TENANT-ID': this.tenantId }
                });
                this.config = await response.json();
                this.displayTime = this.config.display_time * 1000;
            }

            setupEventListeners() {
                document.addEventListener('dblclick', (event) => {
                    event.preventDefault();
                    this.advance();
                });
            }

            async start() {
                if (this.isRunning) return;
                this.isRunning = true;

                try {
                    // Load and display first photo
                    await this.loadAndDisplayNext();
                    // Start preloading the next photo and begin timer
                    this.scheduleNext();
                } catch (error) {
                    this.handleError(error);
                }
            }

            stop() {
                this.isRunning = false;
                this.clearTimer();
            }

            advance() {
                if (!this.isRunning) return;

                this.clearTimer();
                this.loadAndDisplayNext()
                    .then(() => this.scheduleNext())
                    .catch(error => this.handleError(error));
            }

            scheduleNext() {
                this.clearTimer();
                if (!this.isRunning) return;

                // Start preloading the next photo immediately
                this.preloadNext();

                // Schedule the next advance
                this.timer = setTimeout(() => {
                    this.advance();
                }, this.displayTime);
            }

            clearTimer() {
                if (this.timer) {
                    clearTimeout(this.timer);
                    this.timer = null;
                }
            }

            async loadAndDisplayNext() {
                // If we have a preloaded photo, use it instantly
                if (this.nextPhoto && this.nextPhoto.complete) {
                    console.log('Using preloaded photo:', this.nextPhoto.src);
                    this.displayPhoto(this.nextPhoto);
                    this.currentPhoto = this.nextPhoto;
                    this.nextPhoto = null;
                    return;
                }

                // Otherwise, load a new photo
                const photoUrl = await this.fetchNextPhotoUrl();
                const img = await this.loadImage(photoUrl);
                this.displayPhoto(img);
                this.currentPhoto = img;
            }

            async preloadNext() {
                if (this.isPreloading || this.nextPhoto) return;

                this.isPreloading = true;
                try {
                    const photoUrl = await this.fetchNextPhotoUrl();
                    this.nextPhoto = await this.loadImage(photoUrl);
                    console.log('Preloaded next photo:', photoUrl);
                } catch (error) {
                    console.log('Failed to preload next photo:', error.message);
                    this.nextPhoto = null;
                } finally {
                    this.isPreloading = false;
                }
            }

            async fetchNextPhotoUrl() {
                const response = await fetch('/photos/next', {
                    headers: { 'X-TENANT-ID': this.tenantId }
                });
                if (!response.ok) throw response;

                const data = await response.json();
                return data.photo_url;
            }

            async loadImage(url) {
                return new Promise((resolve, reject) => {
                    const img = document.createElement('img');

                    const timeout = setTimeout(() => {
                        reject(new Error(`Image loading timeout: ${url}`));
                    }, 10000);

                    img.onload = () => {
                        clearTimeout(timeout);
                        console.log('Photo loaded successfully:', url);
                        resolve(img);
                    };

                    img.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error(`Failed to load image: ${url}`));
                    };

                    img.src = url;
                });
            }

            displayPhoto(img) {
                this.container.innerHTML = '';
                this.container.appendChild(img);
                // Trigger fade-in effect
                setTimeout(() => img.classList.add('loaded'), 50);
            }

            handleError(error) {
                console.error('Slider error:', error);

                if (error instanceof Response && error.status === 404) {
                    this.showNoPhotos();
                } else {
                    this.showError('Error loading photos');
                }

                // Retry after delay
                this.timer = setTimeout(() => {
                    if (this.isRunning) {
                        this.advance();
                    }
                }, this.retryDelay);
            }

            showError(message) {
                this.container.innerHTML = `<div class="error">${message}</div>`;
            }

            showNoPhotos() {
                this.container.innerHTML = `<div class="no-photos">No photos available. Retrying in ${this.retryDelay/1000} seconds...</div>`;
            }
        }

        // Initialize the slider when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const slider = new PhotoSlider();
            slider.initialize();
        });
    </script>
</body>
</html> 